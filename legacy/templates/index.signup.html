<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Interface with OpenAI Assistant and File Manager</title>
  <style>
    /* Basic styling */
 /* General styles */
body {
    font-family: 'Arial', sans-serif;
    background-color: white; /* Subtle red-orange background */
    margin: 0;
    padding: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.sidebar {
    max-width: 175px;
    background: linear-gradient(to bottom, white, #ffe0b2); /* White to light orange gradient */
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 10px;
    overflow-y: auto;
    transition: all 0.3s ease;
}


.history-item {
    background-color: #e57363; /* Lighter red for history items */
    margin-bottom: 10px;
    padding: 5px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: small;
}

.history-item:hover {
    background-color: #ff7f50; /* Orange hover for history items */
}

.delete-btn {
    background-color: transparent;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    margin-left: 10px;
}

.delete-btn:hover {
    color: #ff4d4d; /* Bright red for delete button hover */
}

.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.header {
    background-color: #7b2303; /* Soft orange header */
    opacity: .5;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.header .logo {
    font-weight: bold;
    font-size: 1.2em;
    color: white;
}

.chat-window {
    flex: 1;
    padding: 20px;
    overflow-y: scroll;
    display: flex;
    flex-direction: column;
    background-color: white; /* Very light orange for chat background */
    border-radius: 12px;
    max-width: 65%;
    margin-left: auto;
    margin-right: auto;
    overflow-y:auto;
}

.input-area {
    padding: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    /* border-top: 1px solid #f4b183;  */
    background-color: #ffffff;
    max-width: 65%;
    text-align: center;
    margin-left: auto;
    margin-right: auto;
    min-width: 65%;
}

.input-area input {
    flex: 1;
    padding: 10px;
    border-radius: 25px;
    border: 1px solid #f4b183;
    outline: none;
    font-size: 1em;
}

.input-area button {
    background-color: #ff7043; /* Brighter orange for send button */
    color: white;
    border: none;
    border-radius: 50%;
    padding: 10px;
    margin-left: 10px;
    cursor: pointer;
}

.input-area button:hover {
    background-color: #e64a19; /* Darker orange on hover */
}


        /* Custom scroll box style */
        .scroll-box {
            /* width: 300px;
            height: 200px; */
            overflow-y: scroll;
            padding: 10px;
            /* background-color: #f0f0f0; */
            border-radius: 8px;
            /* border: 1px solid #ddd; */
        }

        /* WebKit Browsers (Chrome, Safari) */
        .scroll-box::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-box::-webkit-scrollbar-track {
            background: #f0f0f0;  /* Background color of the scrollbar track */
            border-radius: 8px;
        }

        .scroll-box::-webkit-scrollbar-thumb {
            background-color: #aaa;  /* Scrollbar thumb color */
            border-radius: 8px;
            border: 2px solid #f0f0f0;  /* Adds some padding around thumb */
        }

        .scroll-box::-webkit-scrollbar-thumb:hover {
            background-color: #888;  /* Darker on hover */
        }

        /* Firefox */
        .scroll-box {
            scrollbar-width: thin;  /* Thinner scrollbar */
            scrollbar-color: #aaa #f0f0f0;  /* Thumb color and track color */
        }


.file-manager-btn {
    background-color: transparent;
    border: none;
    cursor: pointer;
    margin-right: 10px;
    display: none;
}

.file-manager-btn img {
    width: 24px;
    height: 24px;
}

.new-chat-btn {
    margin: 10px 0;
    background-color: #ff7043; /* Orange for new chat button */
    color: white;
    padding: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.new-chat-btn:hover {
    background-color: #e64a19; /* Darker orange on hover */
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); /* Darkened overlay */
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #fff;
    padding: 30px;
    border-radius: 12px;
    max-width: 600px;
    width: 100%;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    animation: fadeInUp 0.3s ease-in-out;
    text-align: center;
}

.modal-content h3 {
    font-size: 1.8em;
    color: #333;
    margin-bottom: 20px;
    font-weight: bold;
}

.modal-content input[type="file"] {
    padding: 10px;
    border: 2px dashed #f4b183; /* Orange dashed border */
    border-radius: 8px;
    background-color: #fff8f5; /* Subtle red background */
    width: 100%;
    font-size: 1.1em;
    color: #333;
    transition: border-color 0.3s;
}

.modal-content input[type="file"]:hover {
    border-color: #ff7043; /* Brighter orange on hover */
}

.modal-content button {
    background-color: #ff7043; /* Bright orange for button */
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 20px;
}

.modal-content button:hover {
    background-color: #e64a19; /* Darker orange on hover */
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    margin-top: 10px;
    background-color: #ffe0b2; /* Light orange for file items */
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s;
}

.file-item:hover {
    background-color: #ffd180; /* Darker orange on hover */
}

.file-item span {
    font-size: 1.1em;
    color: #333;
}

.file-item button {
    background-color: transparent;
    border: none;
    color: #ff7043;
    cursor: pointer;
    font-size: 1em;
    margin-left: 10px;
    transition: color 0.3s;
}

.file-item button:hover {
    color: #e64a19;
}

.close-btn {
    background-color: #ff4d4d; /* Bright red close button */
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 1.1em;
    cursor: pointer;
    margin-top: 20px;
}

.close-btn:hover {
    background-color: #e60000; /* Darker red on hover */
}

/* Smooth pop-in animation */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Settings Icon */
.settings-icon {
    cursor: pointer;
    width: 24px;
    height: 24px;
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

/* Spinner styling */
#loading-spinner {
    display: none;
    width: 60px;
    height: 60px;
    border: 6px solid rgba(0, 0, 0, 0.1);
    border-top-color: #ff7043; /* Orange spinner */
    border-radius: 50%;
    box-sizing: border-box; /* Ensure padding and border are included in the element's total width and height */
    animation: spin 1s linear infinite;
    position: absolute;
    top: 50%;
    left: 50%;
    /* transform: translate(-50%, -50%); */
    z-index: 1000;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.message {
    padding: 10px;
    border-radius: 15px;
    font-size: 1em;
    margin: 0px;
    min-width: 100px;
}

.user-message {
    margin-bottom: 20px;
    align-self: flex-end;
    justify-content: flex-end;
    background-color: #fbf8f8; /* Light red for user messages */
    margin-left: auto;
    box-shadow: 0px 2px 6px rgb(0, 1, 14);
    border-radius: 15px;
    max-width: 85%;
}

.assistant-message {
    margin-bottom: 20px;
    align-self: flex-start;
    justify-content: flex-start;
    background-color: #fff3e0; /* Very light orange for assistant messages */
    margin-right: auto;
    max-width: 85%;
    box-shadow: 0px 2px 6px rgba(237, 108, 3, 0.678);
    border-radius: 15px;
}

.copy-icon {
    position: relative;
    float: left;
    width: 15px;
    height: 15px;
    cursor: pointer;
    padding: 10px;
    padding-left: 0;
    margin-left: 0;
}


.logout-button {
    margin: 10px 0;
    background-color: #ff7043; /* Orange for new chat button */
    color: white;
    padding: 5px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.logout-button:hover {
    background-color: #e64a19; /* Darker orange on hover */
}
  </style>
</head>
<body>

      <!-- Display the username and logout button if the user is logged in -->
  {% if current_user.is_authenticated %}



  <!-- Sidebar (Message History) -->
  <div class="sidebar" id="sidebar">
    <div>
      
      <img style="width: 100%;margin: auto;" src="/imgs/logo.png">
      <p style="text-align: center;color: #333;">Welcome {{ current_user.username }}</p>
<br>

      <button class="new-chat-btn" onclick="ChatManager.createNewChat()">Create New Chat</button>
      <div id="chat-history-list">
        <!-- Chats will be dynamically inserted here -->
      </div>
    </div>
    <img src="https://cdn-icons-png.flaticon.com/512/126/126472.png" alt="Settings" class="settings-icon" onclick="UIManager.openSettings()">
    <button class="logout-button"><a style="text-decoration: none;color: white;" href="{{ url_for('logout') }}">Logout</a> </button>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <!-- Header -->
    <div style="font-size: x-small;" class="header">
      <div class="logo">E3 v2.0</div>
    </div>
    <div id="loading-spinner"></div>
    <!-- Chat Window -->
     <div class="scroll-box">
    <div class="chat-window" id="chat-window">

      <!-- Chat messages will appear here -->
    </div>
    </div>
    <!-- Input Area -->
    <div class="input-area">
      <!-- File Manager Modal Button -->
      <button class="file-manager-btn" onclick="UIManager.openFileManager()">
        <img src="https://cdn-icons-png.flaticon.com/512/148/148947.png" alt="File Manager">
      </button>

      <input type="text" id="input-message" placeholder="Send a message..." onkeydown="ChatManager.handleKeyPress(event)">
      <button onclick="ChatManager.sendMessage()">Go</button>
      <!-- Loading spinner -->

    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <h3>Settings</h3>
      <p>Here you can configure your preferences.</p>
      <button class="close-btn" onclick="UIManager.closeSettings()">Close</button>
    </div>
  </div>

  <!-- File Manager Modal -->
  <div id="file-manager-modal" class="modal">
    <div class="modal-content">
      <h3>File Manager</h3>
      <input type="file" id="file-upload-modal">
      <button onclick="UIManager.uploadFileFromModal()">Upload</button>
      <div id="file-list">
        <!-- List of files will be dynamically inserted here -->
      </div>
      <button class="close-btn" onclick="UIManager.closeFileManager()">Close</button>
    </div>
  </div>


<!-- Include Marked.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  const ChatManager = {
    currentChatUserId: null,
    currentChatNumber: null,
  
    // Load a specific chat by user_id and chat_number
    loadChat(userId, chatNumber) {
      this.currentChatUserId = userId;
      this.currentChatNumber = chatNumber;
      const inputField = document.getElementById('input-message');
      inputField.placeholder = `You are now chatting in Chat ${chatNumber}`;
  
      fetch(`/chat/${userId}/${chatNumber}/history`)
        .then(response => response.json())
        .then(data => {
          UIManager.clearChatWindow();
          data.messages.forEach(msg =>
            UIManager.appendMessage(msg.message, msg.sender === 'user')
          );
        });
    },
  
    // Send a message
    sendMessage() {
      const input = document.getElementById('input-message');
      const message = input.value;
      const spinner = document.getElementById('loading-spinner');
  
      if (!message.trim() || !this.currentChatUserId || !this.currentChatNumber) return;
  
      if (spinner) {
        spinner.style.display = 'block';
      }
  
      fetch(`/chat/${this.currentChatUserId}/${this.currentChatNumber}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      })
        .then(response => response.json())
        .then(data => {
          UIManager.appendMessage(data.user_message, true);
          UIManager.appendMessage(data.assistant_message, false);
  
          input.value = '';
          if (spinner) {
            spinner.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error sending message:', error);
          if (spinner) {
            spinner.style.display = 'none';
          }
        });
    },
  
    // Create a new chat
    createNewChat() {
      fetch('/chat/new', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          this.loadChat(data.user_id, data.chat_number);
          this.updateChatList();
        });
    },
  
    updateChatList() {
      fetch('/chat-history')
        .then(response => response.json())
        .then(data => {
          UIManager.clearChatHistoryList();
  
          if (data.chats.length === 0) {
            this.createNewChat();
          } else {
            data.chats.forEach(chat =>
              UIManager.createChatHistoryItem(chat.user_id, chat.chat_number)
            );
  
            if (!this.currentChatUserId || !this.currentChatNumber) {
              const firstChat = data.chats[0];
              this.loadChat(firstChat.user_id, firstChat.chat_number);
            }
          }
        });
    },
  
    handleKeyPress(event) {
      if (event.key === 'Enter') {
        this.sendMessage();
      }
    },
  
    deleteChat(userId, chatNumber) {
      fetch(`/chat/${userId}/${chatNumber}/delete`, { method: 'DELETE' })
        .then(response => {
          if (response.ok) {
            this.updateChatList();
          }
        });
    },
  };
  
  const UIManager = {
    // Append a message to the chat window with Markdown support
    appendMessage(content, isUser) {
      const chatWindow = document.getElementById('chat-window');
      const messageContainer = document.createElement('div');
      const messageDiv = document.createElement('div');
  
      messageContainer.classList.add('message-container', isUser ? 'user-message' : 'assistant-message');
      messageDiv.classList.add('message', isUser ? 'user' : 'assistant');
  
      // Parse Markdown content using Marked.js
      const formattedContent = marked.parse(content);
  
      messageDiv.innerHTML = formattedContent;
  
      // Create a copy icon
      const copyIcon = document.createElement('img');
      copyIcon.src = 'imgs/copy_icon.png';
      copyIcon.alt = 'Copy';
      copyIcon.classList.add('copy-icon');
      copyIcon.style.cursor = 'pointer';
  
      // Add functionality to copy content to clipboard
      copyIcon.onclick = () => {
        navigator.clipboard.writeText(content).then(() => {
          alert('Message copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
        });
      };
  
      // Append the copy icon to the message div
      messageDiv.appendChild(copyIcon);
      messageContainer.appendChild(messageDiv);
  
      chatWindow.appendChild(messageContainer);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    },
  
    clearChatWindow() {
      document.getElementById('chat-window').innerHTML = '';
    },
  
    clearChatHistoryList() {
      document.getElementById('chat-history-list').innerHTML = '';
    },
  
    createChatHistoryItem(userId, chatNumber) {
      const historyList = document.getElementById('chat-history-list');
      const historyItem = document.createElement('div');
      historyItem.classList.add('history-item');
      historyItem.textContent = `Chat ${chatNumber}`;
      historyItem.onclick = () => ChatManager.loadChat(userId, chatNumber);
  
      const deleteBtn = document.createElement('button');
      deleteBtn.classList.add('delete-btn');
      deleteBtn.innerHTML = '&times;';
      deleteBtn.onclick = (event) => {
        event.stopPropagation();
        ChatManager.deleteChat(userId, chatNumber);
      };
  
      historyItem.appendChild(deleteBtn);
      historyList.appendChild(historyItem);
    },
  };
  
  // Load chat list on page load
  window.onload = () => ChatManager.updateChatList();
  </script>
  
  

{% else %}
  <p>You are not logged in.</p>
  <a href="{{ url_for('login') }}">Login</a>
  <a href="{{ url_for('signup') }}">Sign Up</a>
{% endif %}
</body>
</html>
